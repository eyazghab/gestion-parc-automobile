<div class="mb-3">
  <h3 class="fw-bold">Gestion des Maintenances</h3>
   <button class="btn btn-info text-white mb-2" (click)="voirCalendrierSuivi()">
    üìÖ Voir le calendrier de suivi
  </button>
</div>


<div class="container mt-4">
  <app-suivi-vehicules (demandeMaintenance)="ouvrirFormulaireMaintenance($event)"></app-suivi-vehicules>

  <app-maintenance #maintenanceComp></app-maintenance>

  <!-- Message d'erreur -->
  <p class="alert alert-danger" *ngIf="error">{{ error }}</p>

  <!-- Message succ√®s -->
  <span *ngIf="message" class="text-success fw-bold">{{ message }}</span>

  <!-- Bouton Ajouter Maintenance -->
  <button class="btn btn-success mb-3 float-end" (click)="toggleAddForm()">
    {{ showAddForm ? 'Annuler' : 'Ajouter une maintenance' }}
  </button>
  <div class="clearfix"></div>

  <!-- Recherche par immatriculation -->
  <div class="mb-3 mt-3">
    <input type="text" class="form-control" placeholder="Rechercher par immatriculation..."
      [(ngModel)]="searchImmatriculation" (input)="filterMaintenances()" />
  </div>

  <!-- Formulaire ajout / modification -->
  <div *ngIf="showAddForm" class="card shadow-sm p-4 mb-4">
    <h5 class="card-title mb-3">
      {{ isEditMode ? 'Modifier Maintenance' : 'Nouvelle Maintenance' }}
    </h5>

    <form [formGroup]="maintenanceForm" (ngSubmit)="onSubmit()">
      <div class="row g-3">

        <!-- Type de Technicien -->
        <div class="col-md-6">
          <label class="form-label fw-semibold">Type de Technicien</label>
          <select [(ngModel)]="selectedType" [ngModelOptions]="{standalone: true}" (change)="filterTechniciensByType()"
            class="form-select" [disabled]="maintenanceForm.get('statut')?.value === 'Termin√©e'">
            <option value="">-- S√©lectionner --</option>
            <option value="INTERNE">INTERNE</option>
            <option value="EXTERNE">EXTERNE</option>
          </select>
        </div>

        <!-- Technicien -->
        <div class="col-md-6">
          <label class="form-label fw-semibold">Technicien</label>
          <select formControlName="technicienId" class="form-select" required
            [disabled]="maintenanceForm.get('statut')?.value === 'Termin√©e'">
            <option [ngValue]="null" disabled>-- S√©lectionner un technicien --</option>
            <option *ngFor="let tech of filteredTechniciens" [value]="tech.idTechnicien">
              {{ tech.nom }} {{ tech.prenom }}
            </option>
          </select>
        </div>

        <!-- Type d‚Äôincident -->
        <div class="col-md-6">
          <label class="form-label fw-semibold">Type d‚Äôincident</label>
          <select formControlName="typeIncident" class="form-select" required
            [disabled]="maintenanceForm.get('statut')?.value === 'Termin√©e'">
            <option [ngValue]="null" disabled>-- S√©lectionner un type d‚Äôincident --</option>
            <option *ngFor="let t of typeIncidents" [value]="t">{{ t }}</option>
          </select>
        </div>

        <!-- V√©hicule -->
        <div class="col-md-6">
          <label class="form-label fw-semibold">V√©hicule</label>
          <select formControlName="vehiculeId" class="form-select" required
            [disabled]="maintenanceForm.get('statut')?.value === 'Termin√©e'">
            <option [ngValue]="null" disabled>-- S√©lectionner un v√©hicule --</option>
            <option *ngFor="let v of vehiculesDisponibles" [value]="v.idVehicule">
              {{ v.immatriculation }}
            </option>
          </select>
        </div>

        <!-- Observations -->
        <div class="col-12">
          <label class="form-label fw-semibold">Observations</label>
          <textarea formControlName="observations" class="form-control" rows="3" placeholder="Saisir les observations"
            [disabled]="maintenanceForm.get('statut')?.value === 'Termin√©e'">
        </textarea>
        </div>

        <!-- FormArray Interventions -->
        <div class="col-12" formArrayName="interventions">
          <div *ngFor="let inter of interventions.controls; let i=index" [formGroupName]="i" class="row g-3 mb-2">

            <!-- Type d‚Äôintervention -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Type d‚Äôintervention</label>
              <select formControlName="typeIntervention" class="form-select" required>
                <option [ngValue]="null" disabled>-- S√©lectionner --</option>
                <option *ngFor="let t of typeInterventions" [value]="t">{{ t }}</option>
                <!-- <option value="AUTRE">Autre</option> -->
              </select>

              <div *ngIf="inter.get('typeIntervention')?.value === 'AUTRE'" class="mt-2">
                <input type="text" class="form-control" placeholder="Pr√©cisez le type d‚Äôintervention"
                  formControlName="autreTypeIntervention" />
              </div>
            </div>

            <!-- Co√ªt total -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Co√ªt Total (‚Ç¨)</label>
              <input type="number" formControlName="coutTotal" class="form-control" min="0" required />
            </div>

            <!-- Bouton Supprimer -->
            <div class="col-12 text-end">
              <button type="button" class="btn btn-danger btn-sm mt-2" (click)="removeIntervention(i)">
                Supprimer
              </button>
            </div>
          </div>

          <!-- Ajouter Intervention -->
          <button type="button" class="btn btn-success btn-sm mt-2" (click)="addIntervention()">
            + Ajouter intervention
          </button>
        </div>

      </div>

      <!-- Boutons Submit / Annuler -->
      <div class="d-flex justify-content-end mt-4">
        <button class="btn btn-primary" type="submit" [disabled]="maintenanceForm.invalid">
          {{ isEditMode ? 'Modifier' : 'Ajouter' }}
        </button>
        <button class="btn btn-outline-secondary ms-2" type="button" (click)="toggleAddForm()">Annuler</button>
      </div>
    </form>
  </div>


  <!-- Tableau regroup√© par statut -->
  <div class="mt-4" *ngFor="let group of groupedMaintenances | keyvalue">
    <h4 class="mb-3">
      <span class="badge" [ngClass]="{
        'bg-secondary text-white': group.key === 'Initialis√©e',
        'bg-warning text-dark': group.key === 'Planifi√©e',
        'bg-primary text-white': group.key === 'En cours',
        'bg-success text-white': group.key === 'Termin√©e'
      }">{{ group.key }}</span>
    </h4>

    <div class="table-responsive mb-4">
      <table class="table table-striped table-bordered align-middle">
        <thead class="table-primary text-center">
          <tr>
            <th>Num√©ro</th>
            <th>Description</th>
            <th>Type Maintenance</th>
            <th>Type Intervention</th>
            <th>Co√ªt Total</th>
            <th>V√©hicule</th>
            <th>Technicien</th>
            <th>Statut</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let m of group.value">
            <td>{{ m.numeroMaintenance }}</td>
            <td>{{ m.observations }}</td>
            <td>{{ m.typeIncident || 'Non sp√©cifi√©' }}</td>
            <td>{{ m.typeIntervention || 'Non sp√©cifi√©' }}</td>
            <td>{{ m.coutTotal | number:'1.2-2' }} ‚Ç¨</td>
            <td>{{ m.vehiculeImmatriculation || 'Non sp√©cifi√©' }}</td>
            <td>{{ m.technicienNom || 'Non sp√©cifi√©' }}</td>
            <td>
              <span class="badge" [ngClass]="{
                'bg-secondary text-white': m.statut === 'Initialis√©e',
                'bg-warning text-dark': m.statut === 'Planifi√©e',
                'bg-primary text-white': m.statut === 'En cours',
                'bg-success text-white': m.statut === 'Termin√©e'
              }">{{ m.statut }}</span>
            </td>
            <td class="text-center">
              <!-- S√©lecteur Statut -->
              <ng-container *ngIf="!m.showPlanificationDates">
                <div class="d-flex align-items-center gap-1">
                  <select class="form-select form-select-sm w-auto" [ngModel]="m.statutTemp"
                    (ngModelChange)="onStatutChangeTemp(m, $event)" [disabled]="m.statut === 'Termin√©e'">
                    <option *ngIf="m.statut === 'Initialis√©e'" value="Planifi√©e">Planifi√©e</option>
                    <option *ngIf="m.statut === 'Planifi√©e'" value="En cours">D√©marrer</option>
                    <option *ngIf="m.statut === 'En cours'" value="Termin√©e">Termin√©e</option>
                    <option *ngIf="m.statut === 'Termin√©e'" value="Termin√©e">Termin√©e</option>
                  </select>
                 
                </div>
              </ng-container>

              <!-- Formulaire Planification -->
              <div *ngIf="m.showPlanificationDates" class="d-flex gap-2 justify-content-center">
                <input type="date" [(ngModel)]="m.tempDateDepart" class="form-control form-control-sm" />
                <input type="date" [(ngModel)]="m.tempDateFin" class="form-control form-control-sm" />
                <button class="btn btn-success btn-sm" (click)="sauvegarderPlanification(m)">‚úîÔ∏è</button>
                <button class="btn btn-danger btn-sm" (click)="m.showPlanificationDates=false">‚ùå</button>
              </div>

            </td>
          </tr>
          <tr *ngIf="group.value.length === 0">
            <td colspan="9" class="text-center text-muted">Aucune maintenance trouv√©e</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>