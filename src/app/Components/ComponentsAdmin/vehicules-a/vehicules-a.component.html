<div class="container mt-4">

  <!-- Bouton Suivi des v√©hicules -->
<!--   <div class="mb-3">
    <li class="nav-item">
      <a class="nav-link btn btn-primary text-white px-3" routerLink="/admin/admin-sante" style="margin-left: 10px;">
        Suivi des v√©hicules
      </a>
    </li>
  </div> -->
  <!-- Message d'erreur -->
  <p class="alert alert-danger" *ngIf="error">{{ error }}</p>

  <!-- Bouton Ajouter un v√©hicule -->
  <button class="btn btn-success mb-3 float-end" (click)="toggleAddForm()">
    {{ showAddForm ? 'Annuler' : 'Ajouter un v√©hicule' }}
  </button>
  <div class="clearfix"></div>

  <!-- Formulaire d'ajout -->
  <div *ngIf="showAddForm" class="form-container mb-4">
    <form [formGroup]="vehiculeForm" (ngSubmit)="onAddSubmit()">
      <div class="mb-2">
        <label for="immatriculation">Immatriculation</label>
        <input id="immatriculation" type="text" formControlName="immatriculation" class="form-control" required />
      </div>

      <div class="mb-2">
        <label for="numeroChassis">Num√©ro Ch√¢ssis</label>
        <input id="numeroChassis" type="text" formControlName="numeroChassis" class="form-control" required />
      </div>

      <div class="mb-2">
        <label for="dateCircu">Date de circulation</label>
        <input id="dateCircu" type="date" formControlName="dateCircu" class="form-control" required />
      </div>

      <div class="mb-2">
        <label for="date_acquisition">Date d'acquisition</label>
        <input id="date_acquisition" type="date" formControlName="date_acquisition" class="form-control" required />
      </div>

      <div class="mb-2">
        <label for="kilometrageActuel">Kilom√©trage actuel</label>
        <input id="kilometrageActuel" type="number" formControlName="kilometrageActuel" class="form-control" required />
      </div>

      <div class="mb-2">
        <label for="anneeModel">Ann√©e mod√®le</label>
        <input id="anneeModel" type="number" formControlName="anneeModel" class="form-control" required />
      </div>

      <div class="mb-2">
        <label for="typeCarburant">Type de carburant</label>
        <input id="typeCarburant" type="text" formControlName="typeCarburant" class="form-control" required />
      </div>

      <div class="mb-2">
        <label for="etat">√âtat</label>
        <select id="etat" formControlName="etat" class="form-select" required>
          <option value="DISPONIBLE">Disponible</option>
          <option value="EN_ATTENTE">En attente</option>
          <option value="EN_PANNE">Indisponible</option>
          <option value="EN_COURS">En cours</option>
        </select>
      </div>

      <div class="mb-2">
        <label for="modele">Mod√®le</label>
        <select id="modele" formControlName="modele" class="form-select" required>
          <option value="" disabled>Choisir un mod√®le</option>
          <option *ngFor="let m of modeles" [value]="m.id">{{ m.nom }}</option>
        </select>
      </div>

      <div class="mb-2">
        <label for="typeCarrosserie">Type de carrosserie</label>
        <select id="typeCarrosserie" formControlName="typeCarrosserie" class="form-select" required>
          <option value="" disabled>Choisir un type</option>
          <option *ngFor="let t of typeCarrosseries" [value]="t.id">{{ t.type }}</option>
        </select>
      </div>

      <button type="submit" class="btn btn-primary mt-2" [disabled]="vehiculeForm.invalid">Ajouter</button>
    </form>
  </div>

  <!-- Recherche -->
  <div class="mb-3">
    <input type="text" class="form-control" placeholder="Rechercher par Immatriculation"
      [(ngModel)]="searchImmatriculation" (ngModelChange)="filtrerVehicules()" />
  </div>

  <!-- Bouton IA -->
  <button class="btn btn-info mb-3" (click)="entrainerModelIA()" [disabled]="training">
    üîÑ Entra√Æner le mod√®le IA
    <span *ngIf="training" class="spinner-border spinner-border-sm ms-2"></span>
  </button>

  <!-- Tableau des v√©hicules -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-primary text-center">
        <tr>
          <th (click)="trierVehicules('immatriculation')">Immatriculation</th>
          <th (click)="trierVehicules('dateCircu')">Date de circulation</th>
          <th (click)="trierVehicules('kilometrageActuel')">Kilom√©trage</th>
          <th (click)="trierVehicules('typeCarburant')">Carburant</th>
          <th (click)="trierVehicules('etat')">√âtat</th>
          <th class="text-center">Pr√©diction IA</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let v of vehiculesFiltres">
          <tr [class.ligne-desactive]="v.etat === 'EN_PANNE'">
            <!-- Infos v√©hicule -->
            <td>{{ v.immatriculation }}</td>
            <td>{{ v.dateCircu | date:'dd/MM/yyyy' }}</td>
            <td>{{ v.kilometrageActuel | number }}</td>
            <td>{{ v.typeCarburant }}</td>
            <td class="text-center">
              <span class="badge px-3 py-2 fs-6" [ngClass]="{
              'bg-warning text-dark': v.etat === 'EN_ATTENTE',
              'bg-primary text-white': v.etat === 'EN_COURS',
              'bg-success text-white': v.etat === 'TRAITE',
              'bg-danger text-white': v.etat === 'EN_PANNE',
              'bg-secondary text-dark': v.etat === 'DISPONIBLE'
            }">{{ v.etat }}</span>
            </td>

            <td class="text-center align-middle">
              <button class="btn btn-outline-secondary btn-sm mb-1"
                (click)="predireMaintenance(v.idVehicule, v.coutTotal ?? 0)" title="Pr√©dire maintenance">
                üß†
              </button>
              <span *ngIf="predictions[v.idVehicule]" class="badge d-block mt-1 p-2 text-wrap" [ngClass]="{
          'bg-success': predictions[v.idVehicule]?.includes('Pas'),
          'bg-warning text-dark': predictions[v.idVehicule]?.includes('Prochaine'),
          'bg-danger': predictions[v.idVehicule]?.includes('Urgente')
        }">
                {{ formatPrediction(predictions[v.idVehicule]) }}
              </span>
            </td>



            <!-- Actions -->
            <td class="text-center">
              <div class="d-flex justify-content-center align-items-center gap-2">
                <button class="btn btn-warning btn-sm" (click)="editVehicule(v)" title="Modifier">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-info btn-sm" (click)="voirDetails(v)" title="Voir d√©tails">
                  <i class="bi bi-info-circle"></i>
                </button>
              </div>
            </td>

          </tr>
        </ng-container>

        <!-- Ligne si aucun v√©hicule -->
        <tr *ngIf="vehiculesFiltres.length === 0">
          <td colspan="10" class="text-center text-muted">Aucun v√©hicule trouv√©</td>
        </tr>
      </tbody>
    </table>
  </div>

</div>