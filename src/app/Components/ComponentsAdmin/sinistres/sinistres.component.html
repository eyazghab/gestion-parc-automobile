<div class="container mt-4">
  <h2 class="text-center mb-4">Liste des Sinistres</h2>

  <div *ngFor="let sinistre of sinistres" class="card mb-3 shadow-sm">
    <div class="card-body">
      <!-- Infos principales -->
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="card-title">üöó {{ sinistre.vehicule?.immatriculation }}</h5>
          <p class="mb-1">üë§ {{ sinistre.utilisateur?.nom }} {{ sinistre.utilisateur?.prenom }}</p>
          <p class="mb-1">üìÖ {{ sinistre.dateSinistre | date:'dd/MM/yyyy' }} √† {{ sinistre.heureSinistre }}</p>
          <p class="mb-1">üìç {{ sinistre.lieuSinistre }}</p>
          <p class="mb-1 text-danger">‚ö†Ô∏è {{ sinistre.degats }}</p>
        </div>

        <!-- Badge √©tat -->
        <span class="badge fs-6"
              [ngClass]="{
                'bg-primary': sinistre.etat === 'DECLARE',
                'bg-warning': sinistre.etat === 'A_MAINTENIR',
                'bg-success': sinistre.etat === 'PAS_DE_TRAITEMENT_NECESSAIRE'
              }">
          {{ sinistre.etat === 'PAS_DE_TRAITEMENT_NECESSAIRE' ? 'Pas de traitement √† faire' : sinistre.etat }}
        </span>
      </div>

      <!-- Bouton d√©tails -->
      <button class="btn btn-sm btn-outline-primary mt-3"
              (click)="sinistre.showDetails = !sinistre.showDetails">
        {{ sinistre.showDetails ? 'Masquer d√©tails' : 'Voir d√©tails' }}
      </button>

      <!-- D√©tails -->
      <div *ngIf="sinistre.showDetails" class="mt-3 border-top pt-3">
        <p><strong>Type :</strong> {{ sinistre.typeIncident }}</p>
        <p><strong>D√©claration :</strong> {{ sinistre.dateDeclaration | date:'dd/MM/yyyy' }} (n¬∞ {{ sinistre.numDeclaration }})</p>

        <!-- Photos miniatures -->
        <div *ngIf="(sinistre.photos || []).length > 0" class="d-flex flex-wrap gap-2 mt-2">
          <img *ngFor="let photo of sinistre.photos"
               [src]="photo"
               alt="Photo sinistre"
               class="photo-thumbnail"
               (click)="openModal(photo, sinistre.photos)" />
        </div>

        <!-- S√©lecteur d'√©tat -->
        <div class="mt-3">
          <label class="form-label">Changer √©tat :</label>
          <select class="form-select form-select-sm"
                  [ngModel]="sinistre.etat"
                  (ngModelChange)="changerEtat(sinistre, $event)">
            <option *ngFor="let etat of getEtatsPossibles(sinistre)" [ngValue]="etat">
              {{ EtatSinistreLabels[etat] }}
            </option>
          </select>
        </div>

        <!-- Formulaire Ajout Maintenance -->
        <div *ngIf="showAddForm && currentSinistreForMaintenance?.id === sinistre.id" 
             class="card shadow-sm p-4 mb-4 mt-3">
          <h4 class="card-title mb-3 text-primary">Ajouter un technicien / prise en charge</h4>

          <form [formGroup]="maintenanceForm" (ngSubmit)="onSubmitMaintenance()">
            <div class="row g-3">

              <!-- S√©lecteur Type Technicien (par sinistre) -->
              <div class="col-md-6">
                <label class="form-label">Type Technicien</label>
                <select class="form-select" [(ngModel)]="sinistre.selectedType" [ngModelOptions]="{standalone: true}" 
                        (change)="onTypeChange(sinistre)">
                  <option value="INTERNE">INTERNE</option>
                  <option value="EXTERNE">EXTERNE</option>
                </select>
              </div>

              <!-- S√©lecteur Technicien -->
              <div class="col-md-6">
                <label class="form-label">Technicien</label>
                <select class="form-select" [(ngModel)]="sinistre.selectedTechnicienId" [ngModelOptions]="{standalone: true}"
                        (change)="onTechnicienChange(sinistre)">
                  <option *ngFor="let t of getTechniciensFiltered(sinistre)" [value]="t.idTechnicien">
                    {{ t.nom }} {{ t.prenom }}
                  </option>
                </select>
              </div>

              <!-- Circulation -->
              <div class="col-md-6">
                <label class="form-label">Circulation</label>
                <select class="form-select" formControlName="circulation">
                  <option value="INTERDITE">INTERDITE</option>
                  <option value="POSSIBLE">POSSIBLE</option>
                </select>
              </div>

              <!-- V√©hicule (readonly) -->
              <div class="col-md-6">
                <label class="form-label">V√©hicule</label>
                <input type="text" class="form-control" 
                       [value]="currentSinistreForMaintenance.vehicule?.immatriculation" readonly />
              </div>

            </div>

            <div class="text-end mt-3">
              <button class="btn btn-primary" type="submit" [disabled]="maintenanceForm.invalid">
                Confirmer
              </button>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- üì∑ Modale Photos -->
<div *ngIf="modalOpen" class="modal-backdrop-custom">
  <span class="modal-close" (click)="closeModal()">&times;</span>
  <span class="modal-prev" (click)="prevPhoto()">&#10094;</span>
  <img [src]="modalImage" class="modal-image" />
  <span class="modal-next" (click)="nextPhoto()">&#10095;</span>
</div>
