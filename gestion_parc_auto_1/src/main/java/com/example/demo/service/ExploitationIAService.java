package com.example.demo.service;

import com.example.demo.model.OrdreMission;
import com.example.demo.model.Vehicule;
import com.example.demo.model.Maintenance;
import org.springframework.stereotype.Service;
import smile.regression.RandomForest;
import smile.data.DataFrame;
import smile.data.Tuple;
import smile.data.formula.Formula;
import smile.data.vector.DoubleVector;

import java.util.List;
import java.util.Properties;

@Service
public class ExploitationIAService {

    private RandomForest model;
    private DataFrame schemaDf;
    private boolean modelTrained = false;

    public boolean isModelTrained() { return modelTrained; }

    public void trainModel(List<OrdreMission> missions) {
        int n = missions.size();
        if (n == 0) throw new RuntimeException("Pas de données pour entraîner le modèle");

        double[] distance = new double[n];
        double[] conso = new double[n];
        double[] maintenance = new double[n];
        double[] coutTotal = new double[n];

        for (int i = 0; i < n; i++) {
            OrdreMission m = missions.get(i);
            Vehicule v = m.getVehicule();

            distance[i] = m.getDistanceEstimee() != null ? m.getDistanceEstimee() : 0.0;
            conso[i] = v.getConsommationMoyenne() != null ? v.getConsommationMoyenne() : 8.0;

            // Calcul moyenne maintenance
            maintenance[i] = v.getMaintenances() != null && !v.getMaintenances().isEmpty()
                ? v.getMaintenances().stream().mapToDouble(Maintenance::getCoutTotal).average().orElse(0.0)
                : 0.0;

            coutTotal[i] = (distance[i] * conso[i] / 100) + maintenance[i];
        }

        schemaDf = DataFrame.of(
                DoubleVector.of("distance", distance),
                DoubleVector.of("conso", conso),
                DoubleVector.of("maintenance", maintenance),
                DoubleVector.of("coutTotal", coutTotal)
        );

        Properties props = new Properties();
        props.setProperty("trees", "100");
        props.setProperty("maxDepth", "10");

        model = RandomForest.fit(Formula.lhs("coutTotal"), schemaDf, props);
        modelTrained = true;
        System.out.println("✅ Modèle coût total entraîné");
    }

    public double predict(OrdreMission mission) {
        if (!modelTrained || model == null) return -1;

        double distance = mission.getDistanceEstimee() != null ? mission.getDistanceEstimee() : 0.0;
        double conso = mission.getVehicule().getConsommationMoyenne() != null ? mission.getVehicule().getConsommationMoyenne() : 8.0;
        double maintenance = mission.getVehicule().getMaintenances() != null && !mission.getVehicule().getMaintenances().isEmpty()
                ? mission.getVehicule().getMaintenances().stream().mapToDouble(Maintenance::getCoutTotal).average().orElse(0.0)
                : 0.0;

        Tuple input = Tuple.of(new Object[]{distance, conso, maintenance}, schemaDf.schema());
        return model.predict(input);
    }
}
