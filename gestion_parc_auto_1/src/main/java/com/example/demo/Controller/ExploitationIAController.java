package com.example.demo.Controller;


import com.example.demo.Repository.OrdreMissionRepository;
import com.example.demo.model.OrdreMission;
import com.example.demo.service.ExploitationIAService;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/exploitation")
public class ExploitationIAController {

    @Autowired
    private ExploitationIAService iaService;

    @Autowired
    private OrdreMissionRepository missionRepository;

    /**
     * Entraîner le modèle IA sur toutes les missions existantes
     */
    @PostMapping("/train")
    public String trainModel() {
        List<OrdreMission> missions = missionRepository.findAll();
        if (missions.isEmpty()) return "❌ Pas de missions disponibles pour entraîner le modèle";

        iaService.trainModel(missions);
        return "✅ Modèle IA coût total entraîné avec succès";
    }

    /**
     * Prédire le coût total pour une mission donnée
     */
    @GetMapping("/predict/{missionId}")
    public Object predictCost(@PathVariable Long missionId) {
        OrdreMission mission = missionRepository.findById(missionId).orElse(null);
        if (mission == null) return "❌ Mission introuvable";

        double prediction = iaService.predict(mission);
        if (prediction < 0) return "❌ Modèle non entraîné";

        return new PredictionResponse(missionId, prediction);
    }

    /**
     * Classe interne pour structurer la réponse JSON
     */
    private static class PredictionResponse {
        public Long missionId;
        public double coutTotal;

        public PredictionResponse(Long missionId, double coutTotal) {
            this.missionId = missionId;
            this.coutTotal = coutTotal;
        }
    }
}
